<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™© (Public View v9.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 300px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fbcfe8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f472b6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; position: relative; }
        th.sortable:hover { background-color: #fdf2f8 !important; color: #db2777 !important; }
        .force-hide { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .nav-item.active { background-color: #fdf2f8; color: #ec4899; box-shadow: inset 4px 0 0 #ec4899; }
        #msgBox { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; pointer-events: none; }
        #msgBox.show { transform: translateY(0); opacity: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; text-align: center; font-size: 0.75rem; }
        .calendar-day { padding: 0.25rem; border-radius: 0.75rem; position: relative; transition: all 0.2s; min-height: 48px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; aspect-ratio: 1/1; cursor: pointer; border: 1px solid transparent; }
        @media (min-width: 1024px) { .calendar-day { min-height: 56px; } }
        .calendar-day:hover { background-color: #f9fafb; border-color: #fbcfe8; }
        .calendar-day.today { background-color: #ec4899; color: white; font-weight: bold; }
        .calendar-day.thursday { color: #db2777; background-color: #fdf2f8; border: 1px solid #fbcfe8; font-weight: bold; }
        .calendar-day.not-current { opacity: 0.2; pointer-events: none; }
        .calendar-head { font-size: 0.7rem; font-weight: 800; color: #9ca3af; text-transform: uppercase; padding-bottom: 8px; }
        .event-dot { width: 4px; height: 4px; background-color: #ec4899; border-radius: 50%; margin-top: 2px; }
        .calendar-day.today .event-dot { background-color: white; }
        
        .event-snippet { 
            font-size: 10px; 
            color: #1f2937; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%; 
            margin-top: 3px; 
            line-height: 1.2; 
            font-weight: 800; 
            background-color: rgba(236, 72, 153, 0.18); 
            border-radius: 4px;
            padding: 2px 4px;
        }
        @media (min-width: 1024px) { .event-snippet { font-size: 11px; } }
        .calendar-day.today .event-snippet { color: white; background-color: rgba(255, 255, 255, 0.2); }
        .calendar-day.thursday .event-snippet { color: #be123c; background-color: rgba(159, 18, 57, 0.13); }

        .score-zero { background-color: #fee2e2 !important; color: #ef4444 !important; }
        .score-cell { transition: background 0.2s; }
        .score-cell:hover { background-color: #f8fafb; }

        /* Mobile Card Styles for Members */
        .member-card {
            background: white;
            border: 1px solid #f3f4f6;
            border-radius: 1.25rem;
            padding: 1rem;
            transition: all 0.2s;
        }
        .member-card:hover {
            border-color: #fbcfe8;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.08);
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @supports (padding-top: env(safe-area-inset-top)) { body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); } }
        @media (max-width: 640px) {
            .calendar-grid { gap: 0.125rem; font-size: 0.65rem; }
            .calendar-day { min-height: 38px; padding: 0.125rem; }
            .calendar-head { font-size: 0.6rem; padding-bottom: 4px; }
            .event-snippet { font-size: 8px; padding: 0px 1px; }
            #msgBox { left: 1rem; right: 1rem; transform: translateX(0) translateY(100px) !important; width: auto; padding: 0.75rem 1rem; }
            #msgBox.show { transform: translateX(0) translateY(0) !important; }
        }
        @media (max-width: 768px) { table { font-size: 0.65rem; } table th, table td { padding: 0.5rem 0.375rem !important; } table th { font-size: 9px; } }
        .overflow-y-auto, .overflow-x-auto { -webkit-overflow-scrolling: touch; }
        .nav-item, button { -webkit-tap-highlight-color: transparent; }

        /* Sticky first column for analysis table on mobile */
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(2) {
            position: sticky;
            z-index: 20;
            background: inherit;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table tbody td:nth-child(1) {
            left: 0;
        }
        .analysis-table-wrap table thead th:nth-child(2),
        .analysis-table-wrap table tbody td:nth-child(2) {
            left: 50px;
        }
        .analysis-table-wrap table thead th:nth-child(1),
        .analysis-table-wrap table thead th:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(1),
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            background: white;
        }
        .analysis-table-wrap table tbody tr:hover td:nth-child(1),
        .analysis-table-wrap table tbody tr:hover td:nth-child(2) {
            background: #f9fafb;
        }
        .analysis-table-wrap table tbody tr td:nth-child(2) {
            border-right: 2px solid #f3f4f6;
        }
        .analysis-table-wrap table thead th:nth-child(2) {
            border-right: 2px solid #e5e7eb;
        }

        /* Sticky columns for analysis table



        thead th { position: sticky; top: 0; z-index: 20; background: inherit; }



        /* Sticky table header */
        .stick-head { border-collapse: separate; border-spacing: 0; }
        .stick-head thead th { position: sticky; top: 0; z-index: 10; background: #f9fafb; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden flex font-medium">

    <div id="loadingOverlay">
        <div class="text-center w-72">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-100 text-2xl mx-auto mb-6">ëš </div>
            <p class="text-gray-800 font-black text-lg tracking-tight mb-1">ëš ì¹´ë¡± ê¸¸ë“œ ê´€ë¦¬</p>
            <p id="loadingStatus" class="text-gray-400 font-bold text-xs mb-6">ì„œë²„ ì—°ê²° ì¤‘...</p>
            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden mb-3">
                <div id="loadingBar" class="h-full bg-gradient-to-r from-pink-400 to-rose-400 rounded-full transition-all duration-500 ease-out" style="width:5%"></div>
            </div>
            <p id="loadingPct" class="text-[10px] text-gray-300 font-bold">0%</p>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-4 right-4 sm:left-1/2 sm:right-auto sm:-translate-x-1/2 z-[200] bg-slate-900 text-white px-5 lg:px-8 py-3 lg:py-4 rounded-xl lg:rounded-2xl shadow-2xl flex items-center gap-3 lg:gap-4 border border-white/10 max-w-md mx-auto sm:mx-0">
        <div id="msgIcon" class="text-pink-500"><i class="fas fa-info-circle"></i></div>
        <p id="msgText" class="text-sm font-bold"></p>
    </div>

    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-[1000] w-64 bg-white border-r border-gray-100 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col shadow-sm">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-pink-400 to-rose-400 flex items-center justify-center text-white font-bold shadow-lg shadow-pink-200 text-xl">ëš </div>
            <div><h1 class="text-lg font-bold text-gray-800 tracking-tight">ëš ì¹´ë¡± ê¸¸ë“œ í˜„í™©</h1><p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest leading-none mt-1">PUBLIC VIEW</p></div>
            <button id="closeSidebar" class="lg:hidden ml-auto text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2 flex-1 overflow-y-auto no-scrollbar">
            <p class="px-4 pt-1 pb-1 text-[9px] text-gray-400 font-bold uppercase tracking-widest">ê¸¸ë“œ ì•ˆë‚´</p>
            <button onclick="router('guide_intro')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_intro"><i class="fas fa-heart w-5 text-center text-xs"></i><span>ê¸¸ë“œ ì†Œê°œ</span></button>
            <button onclick="router('guide_ranks')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_ranks"><i class="fas fa-medal w-5 text-center text-xs"></i><span>ì§ìœ„ & ë¶€ìº</span></button>
            <button onclick="router('guide_links')" class="nav-item w-full flex items-center space-x-3 px-4 py-2.5 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold text-sm" data-target="guide_links"><i class="fas fa-link w-5 text-center text-xs"></i><span>ë§í¬ ëª¨ìŒ</span></button>
            <div class="my-2 border-t border-gray-200"></div>
            <p class="px-4 pt-1 pb-1 text-[9px] text-gray-400 font-bold uppercase tracking-widest">ê¸¸ë“œ ë°ì´í„°</p>
            <button onclick="router('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="dashboard"><i class="fas fa-columns w-5 text-center"></i><span>ëŒ€ì‹œë³´ë“œ</span></button>
            <button onclick="router('members')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="members"><i class="fas fa-users w-5 text-center"></i><span>ê¸¸ë“œì› ëª©ë¡</span></button>
            <button onclick="router('analysis')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="analysis"><i class="fas fa-chart-line w-5 text-center"></i><span>ìˆ˜ë¡œ ì ìˆ˜ ë¶„ì„</span></button>
            <button onclick="router('bail')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="bail"><i class="fas fa-gem w-5 text-center"></i><span>ë³´ì„ê¸ˆ í˜„í™©</span></button>
            <button onclick="router('penalty')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-pink-50 font-bold" data-target="penalty"><i class="fas fa-exclamation-triangle w-5 text-center"></i><span>ë²Œì  í˜„í™©</span></button>
        </nav>
        <div class="p-4 border-t border-gray-100 bg-gray-50/50 text-center font-bold"><p class="text-[10px] text-green-500 uppercase tracking-widest"><i class="fas fa-cloud mr-1 animate-pulse"></i> Database Connected</p></div>
    </aside>

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/10 z-[990] hidden lg:hidden"></div>

    <main class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative z-0">
        <header class="h-14 lg:h-16 bg-white border-b border-gray-200 flex items-center justify-between px-3 lg:px-8 shrink-0 z-10 shadow-sm relative">
            <div class="flex items-center gap-2 lg:gap-4 min-w-0"><button id="openSidebar" class="p-2 lg:hidden rounded-lg hover:bg-gray-100 text-gray-600 shrink-0"><i class="fas fa-bars text-lg"></i></button><h2 id="pageTitle" class="text-base lg:text-xl font-bold text-gray-800 tracking-tight truncate">ëŒ€ì‹œë³´ë“œ</h2></div>
            <div class="flex items-center gap-2 lg:gap-4 shrink-0">
                <div class="px-3 lg:px-4 py-1.5 bg-pink-50 text-pink-600 rounded-full text-[10px] lg:text-[11px] font-bold border border-pink-100 shadow-sm hidden sm:block">
                    âœ¨ <span id="anniversaryLabel">ë¡œë”© ì¤‘...</span>
                </div>
                <div class="flex items-center gap-1" id="totalMembersCount">
                    <span class="text-[9px] lg:text-[10px] text-gray-300 font-bold">ë¡œë”© ì¤‘...</span>
                </div>
                <button id="refreshBtn" onclick="fetchMembers()" class="w-8 h-8 lg:w-10 lg:h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 text-gray-400 transition-all border border-gray-100 shadow-sm"><i class="fas fa-sync-alt text-xs lg:text-base"></i></button>
            </div>
        </header>
        <div id="contentArea" class="flex-1 overflow-y-auto p-2 sm:p-3 lg:p-6 relative bg-gray-50 flex flex-col min-h-0"></div>
    </main>

    <div id="eventDetailModal" class="fixed inset-0 z-[2000] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden fade-in font-bold p-4">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-sm p-8 lg:p-10 border border-gray-50 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-5 lg:mb-6 shrink-0">
                <h3 id="eventDetailDate" class="text-xl lg:text-2xl font-black text-slate-800 tracking-tighter">Date</h3>
                <button onclick="closeModal('eventDetailModal')" class="text-gray-400 hover:text-gray-600 text-lg lg:text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="eventListForDate" class="flex flex-col gap-2 overflow-y-auto no-scrollbar max-h-[60vh]">
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://luglshrfkkeacmefnvlm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1Z2xzaHJma2tlYWNtZWZudmxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNjE0NTIsImV4cCI6MjA4NzYzNzQ1Mn0.LrJ-ejXJGqVGzrJyL5nFW45J92-MxrcKuEpE2EGNsIo';
        const supaDb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let GUILD_START_DATE = new Date('2020-03-17');
        const MAPLE_JOBS = ["íˆì–´ë¡œ", "ë‹¤í¬ë‚˜ì´íŠ¸", "íŒ”ë¼ë”˜", "ë¶ˆë…", "ì¬ì½œ", "ë¹„ìˆ", "ë³´ìš°ë§ˆìŠ¤í„°", "ì‹ ê¶", "íŒ¨ìŠ¤íŒŒì¸ë”","ë‚˜ì´íŠ¸ë¡œë“œ", "ì„€ë„ì–´", "ë“€ì–¼ë¸”ë ˆì´ë“œ", "ìº¡í‹´", "ë°”ì´í¼", "ìºë…¼ë§ˆìŠ¤í„°","ë¯¸í•˜ì¼", "ì†Œìš¸ë§ˆìŠ¤í„°", "í”Œë ˆì„ìœ„ìë“œ", "ìœˆë“œë¸Œë ˆì´ì»¤", "ë‚˜ì´íŠ¸ì›Œì»¤", "ìŠ¤íŠ¸ë¼ì´ì»¤","ì•„ë€", "ì—ë°˜", "ë£¨ë¯¸ë„ˆìŠ¤", "ë©”ë¥´ì„¸ë°ìŠ¤", "íŒ¬í…€", "ì€ì›”","ë°ëª¬ ìŠ¬ë ˆì´ì–´", "ë°ëª¬ ì–´ë²¤ì ¸", "ë¸”ë˜ìŠ¤í„°", "ë°°í‹€ë©”ì´ì§€", "ì™€ì¼ë“œí—Œí„°", "ë©”ì¹´ë‹‰", "ì œë…¼","ì¹´ì´ì €", "ì¹´ì¸", "ì¹´ë°ë‚˜", "ì—”ì ¤ë¦­ë²„ìŠ¤í„°","ë¼ë¼", "í˜¸ì˜", "ì•„ë¸", "ì¼ë¦¬ì›€", "ì•„í¬", "ì¹¼ë¦¬","ì œë¡œ", "í‚¤ë„¤ì‹œìŠ¤", "ë Œ"];
        const baseRanks = ['ë§ˆì¹´ë¡±', 'ë‹¤ì¿ ì•„ì¦ˆ'];
        let initialGuildRanks = {
            'ëš ì¹´ë¡±': [...baseRanks, 'í¬ë¼ìš´', 'íŒŒë¥´í˜', 'í‹°ë¼ë¯¸ìŠˆ', 'í¬ë¡œì¹¸ìŠˆ', 'ë¡¤ì¼€ì´í¬', 'íŒ¬ì¼€ì´í¬', 'ì™€í”Œ', 'ìŠ¤ì½˜', 'ë°˜ì£½(íœ´ë©´)'],
            'ëš±ì¹´ë¡±': [...baseRanks, 'ëš ì¼€ì´í¬', 'ëš ë¸Œë ˆë“œ', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë¶€íŒ¬ì¼€ì´í¬', 'ìˆ˜í”Œë ˆ', 'ëš ìŠ¤ì½˜', 'ë¶€ì¼€ì´í¬', 'ë°˜ì£½(íœ´ë©´)'],
            'ë°¤ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ë³„ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ë‹¬ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)'],
            'ê¿€ì¹´ë¡±': [...baseRanks, 'ë¶€íŒ¬ì¼€ì´í¬', 'ë¶€ì¼€ì´í¬', 'ì•„ì¸ìŠˆí˜ë„ˆ', 'ë°˜ì£½(íœ´ë©´)']
        };
        const ITEMS_PER_PAGE = 17;

        let jobChartInstance = null;
        let analysisChartInstance = null;

        const appState = {
            activeTab: 'guide_intro',
            guilds: [
                { id: 'ddun', name: 'ëš ì¹´ë¡±', type: 'ë©”ì¸ 1ê¸°', color: '#f472b6', icon: 'fa-crown', max: 200 },
                { id: 'ddung', name: 'ëš±ì¹´ë¡±', type: 'ë©”ì¸ 2ê¸°', color: '#fb7185', icon: 'fa-heart', max: 200 },
                { id: 'bam', name: 'ë°¤ì¹´ë¡±', type: 'ë¶€ìº 1ê¸°', color: '#6366f1', icon: 'fa-moon', max: 200 },
                { id: 'byeol', name: 'ë³„ì¹´ë¡±', type: 'ë¶€ìº 2ê¸°', color: '#facc15', icon: 'fa-star', max: 200 },
                { id: 'dal', name: 'ë‹¬ì¹´ë¡±', type: 'ë¶€ìº 3ê¸°', color: '#60a5fa', icon: 'fa-sun', max: 200 },
                { id: 'kkul', name: 'ê¿€ì¹´ë¡±', type: 'ë¶€ìº 4ê¸°', color: '#fbbf24', icon: 'fa-cube', max: 200 },
            ],
            members: [], history: [], bailHistory: [], suroHeaders: [],
            events: [],
            penaltyHistory: [],
            filters: { guild: 'all', search: '', sortField: 'name', sortOrder: 'asc' },
            analysisFilters: { sortField: 'avg', sortOrder: 'desc', search: '' },
            analysisGuild: 'ëš ì¹´ë¡±',
            calendarView: { year: new Date().getFullYear(), month: new Date().getMonth() },
            guildRanks: initialGuildRanks,
            currentSelectedDate: null,
            pagination: { members: 1, analysis: 1 } 
        };

        window.showMsg = (text, type = 'info') => {
            const box = document.getElementById('msgBox'); if(!box) return;
            document.getElementById('msgText').innerText = text;
            box.classList.add('show'); setTimeout(() => box.classList.remove('show'), 3500);
        };
        window.showLoading = (show) => { document.getElementById('loadingOverlay')?.classList.toggle('force-hide', !show); };
        window.setLoadProgress = (pct, status) => {
            const bar = document.getElementById('loadingBar');
            const pctEl = document.getElementById('loadingPct');
            const statusEl = document.getElementById('loadingStatus');
            if(bar) bar.style.width = pct + '%';
            if(pctEl) pctEl.textContent = pct + '%';
            if(status && statusEl) statusEl.textContent = status;
        };
        
        window.getAnniversaryInfo = () => {
            const now = new Date(); const diff = now - GUILD_START_DATE;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const years = Math.floor(days / 365);
            const remainingDays = days % 365;
            return { totalDays: days, years, remainingDays };
        };
        
        window.updateAnniversaryLabel = () => {
            const anniv = window.getAnniversaryInfo();
            const el = document.getElementById('anniversaryLabel');
            if (el) el.innerText = `ëš ì¹´ë¡±ì´ ìƒì„±ëœ ì§€ ${anniv.totalDays}ì¼ (${anniv.years}ë…„ ${anniv.remainingDays}ì¼)`;
        };

        window.calculateTotalSuro = (guildName) => {
            if (!appState.suroHeaders || appState.suroHeaders.length === 0) return 0;
            const lastHeader = appState.suroHeaders[appState.suroHeaders.length - 1];
            return appState.members
                .filter(m => (m.guild || '').trim() === guildName.trim())
                .reduce((s, m) => s + (Math.round(Number(m.suro?.[lastHeader])) || 0), 0);
        };

        window.getAdminBailStats = () => {
            const stats = {};
            appState.bailHistory.forEach(h => { const amount = parseInt(h.amount) || 0; stats[h.receiver] = (stats[h.receiver] || 0) + amount; });
            return Object.entries(stats).sort((a,b) => a[0].localeCompare(b[0], 'ko'));
        };

        let ROLE_PRIORITY = {'ë§ˆì¹´ë¡±':0,'ë‹¤ì¿ ì•„ì¦ˆ':1,'í¬ë¼ìš´':2,'íŒŒë¥´í˜':3,'í‹°ë¼ë¯¸ìŠˆ':4,'í¬ë¡œì¹¸ìŠˆ':5,'ë¡¤ì¼€ì´í¬':6,'íŒ¬ì¼€ì´í¬':7,'ì™€í”Œ':8,'ìŠ¤ì½˜':9,'ë°˜ì£½':10,'ë°˜ì£½(íœ´ë©´)':10,'ëš ì¼€ì´í¬':2,'ëš ë¸Œë ˆë“œ':3,'ì•„ì¸ìŠˆí˜ë„ˆ':4,'ë¶€íŒ¬ì¼€ì´í¬':5,'ìˆ˜í”Œë ˆ':6,'ëš ìŠ¤ì½˜':7,'ë¶€ì¼€ì´í¬':8};

        function smartCompare(a, b, field, order) {
            let valA = a[field]; let valB = b[field];
            if (field === 'mainInfo') {
                valA = a.isMain ? a.name : (a.mainCharName || "");
                valB = b.isMain ? b.name : (b.mainCharName || "");
            }
            if (field === 'role') {
                const pA = ROLE_PRIORITY[valA] !== undefined ? ROLE_PRIORITY[valA] : 99;
                const pB = ROLE_PRIORITY[valB] !== undefined ? ROLE_PRIORITY[valB] : 99;
                if (pA !== pB) return order === 'asc' ? pA - pB : pB - pA;
                return 0;
            }
            if (valA === valB) return 0;
            const numA = parseFloat(valA); const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) { return order === 'asc' ? numA - numB : numB - numA; }
            const strA = String(valA || ""); const strB = String(valB || "");
            const res = strA < strB ? -1 : 1;
            return order === 'asc' ? res : -res;
        }

        window.getNicknameIcon = (role) => {
            if (role === 'ë§ˆì¹´ë¡±') return '<i class="fas fa-crown text-blue-500 mr-2 shadow-sm"></i>';
            if (role === 'ë‹¤ì¿ ì•„ì¦ˆ') return '<i class="fas fa-crown text-pink-500 mr-2 shadow-sm"></i>';
            return '<span class="w-3 h-3 rounded-full bg-gray-200 mr-2 inline-block"></span>';
        };

        let ROLE_DISPLAY = {
            'í¬ë¼ìš´':  { emoji:'ğŸ‘‘', color:'text-amber-600' },
            'íŒŒë¥´í˜':  { emoji:'ğŸ¨', color:'text-blue-600' },
            'í‹°ë¼ë¯¸ìŠˆ': { emoji:'ğŸ°', color:'text-blue-600' },
            'í¬ë¡œì¹¸ìŠˆ': { emoji:'ğŸ¥', color:'text-green-600' },
            'ë¡¤ì¼€ì´í¬': { emoji:'ğŸ¥', color:'text-pink-600' },
            'íŒ¬ì¼€ì´í¬': { emoji:'ğŸ¥', color:'text-pink-500' },
            'ì™€í”Œ':    { emoji:'ğŸ§‡', color:'text-orange-500' },
            'ìŠ¤ì½˜':    { emoji:'ğŸª', color:'text-gray-500' },
            'ë°˜ì£½(íœ´ë©´)':{ emoji:'ğŸ«“', color:'text-gray-400' },
            'ë°˜ì£½':    { emoji:'ğŸ«“', color:'text-gray-400' },
            'ë§ˆì¹´ë¡±':  { emoji:'ğŸ‘‘', color:'text-blue-600' },
            'ë‹¤ì¿ ì•„ì¦ˆ': { emoji:'ğŸ‘‘', color:'text-pink-600' },
            'ëš ì¼€ì´í¬': { emoji:'ğŸ‚', color:'text-pink-600' },
            'ëš ë¸Œë ˆë“œ': { emoji:'ğŸ', color:'text-pink-500' },
            'ì•„ì¸ìŠˆí˜ë„ˆ':{ emoji:'â˜•', color:'text-amber-500' },
            'ë¶€íŒ¬ì¼€ì´í¬':{ emoji:'ğŸ¥', color:'text-amber-500' },
            'ìˆ˜í”Œë ˆ':  { emoji:'ğŸ®', color:'text-orange-500' },
            'ëš ìŠ¤ì½˜':  { emoji:'ğŸª', color:'text-gray-500' },
            'ë¶€ì¼€ì´í¬': { emoji:'ğŸ°', color:'text-gray-400' }
        };
        let SURO_EXEMPT = ['í¬ë¼ìš´','íŒŒë¥´í˜','í‹°ë¼ë¯¸ìŠˆ','í¬ë¡œì¹¸ìŠˆ'];
        let SURO_EXEMPT_LABEL = 'ì•„ì¸ìŠˆí˜ë„ˆ';
        let SURO_EXEMPT_NOTE = 'í¬ë¡œì¹¸ìŠˆ ì´ìƒ â€” ë¶€ìº ì „ë¶€ ìˆ˜ë¡œ ë©´ì œ';
        let SITE_CONFIG = null;
        let ROW_HIGHLIGHT_ROLES = {
            'í¬ë¼ìš´': { background:'linear-gradient(to right,#FFF9E6,#FFF3CC)', borderLeft:'3px solid #F0C050' },
            'íŒŒë¥´í˜': { background:'linear-gradient(to right,#EBF0FF,#E4EAFF)', borderLeft:'3px solid #8EA8F0' },
            'í‹°ë¼ë¯¸ìŠˆ': { background:'linear-gradient(to right,#EBF0FF,#E8EDFF)', borderLeft:'3px solid #A0B4E8' },
            'í¬ë¡œì¹¸ìŠˆ': { background:'linear-gradient(to right,#EEFFEE,#E5FAE5)', borderLeft:'3px solid #92D050' }
        };

        function formatRankWithSuffix(rank) {
            if (!rank) return '-';
            const d = ROLE_DISPLAY[rank];
            const emoji = d ? d.emoji : '';
            const suffix = SURO_EXEMPT.includes(rank) ? ` <span class="text-[8px] text-blue-400 font-bold">(${SURO_EXEMPT_LABEL})</span>` : '';
            const displayName = rank === 'ë°˜ì£½' ? 'ë°˜ì£½(íœ´ë©´)' : rank;
            return `${emoji} ${displayName}${suffix}`;
        }

        function formatRoleHtml(role) {
            const d = ROLE_DISPLAY[role];
            if (!d) return `<span class="text-[10px] text-gray-500">${role || '-'}</span>`;
            const displayName = role === 'ë°˜ì£½' ? 'ë°˜ì£½(íœ´ë©´)' : role;
            const suffix = SURO_EXEMPT.includes(role) ? `<span class="text-[7px] text-blue-400 font-bold ml-0.5">(${SURO_EXEMPT_LABEL})</span>` : '';
            return `<span class="text-[10px] font-bold ${d.color}">${d.emoji} ${displayName}</span>${suffix}`;
        }

        window.getSuroPeriodHeader = (dateObj) => { 
            const now = dateObj || new Date(); 
            const day = now.getDay(); 
            let daysSinceWed = day - 3; 
            if (daysSinceWed < 0) daysSinceWed += 7; 
            const endDate = new Date(now); 
            endDate.setDate(now.getDate() - daysSinceWed); 
            const startDate = new Date(endDate); 
            startDate.setDate(endDate.getDate() - 6); 
            const f = (d) => { 
                const yy = d.getFullYear().toString().slice(-2);
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                return `${yy}-${mm}-${dd}`;
            };
            return `${f(startDate)}(ëª©) ~ ${f(endDate)}(ìˆ˜) ìˆ˜ë¡œ ì ìˆ˜`; 
        };

        window.fetchMembers = async () => {
            window.showLoading(true);
            try {
                // í—¬í¼: 1000í–‰ ì œí•œ ìš°íšŒ
                async function fetchAll(table, orderCol, selectCols = '*', ascending = true) {
                    const pageSize = 1000;
                    let allData = [], from = 0;
                    while (true) {
                        const { data, error } = await supaDb.from(table).select(selectCols).order(orderCol, { ascending }).range(from, from + pageSize - 1);
                        if (error) throw error;
                        allData = allData.concat(data || []);
                        if (!data || data.length < pageSize) break;
                        from += pageSize;
                    }
                    return allData;
                }

                // site_config ë¡œë“œ (ë””ìì¸ ì„¤ì •)
                try {
                    const { data: cfgRow } = await supaDb.from('site_config').select('config').eq('id', 1).maybeSingle();
                    if (cfgRow && cfgRow.config) {
                        const cfg = cfgRow.config;
                        SITE_CONFIG = cfg;
                        if (cfg.guilds) appState.guilds = cfg.guilds;
                        if (cfg.ranks) {
                            initialGuildRanks = cfg.ranks;
                            appState.guildRanks = cfg.ranks;
                        }
                        if (cfg.roleDisplay) ROLE_DISPLAY = cfg.roleDisplay;
                        if (cfg.suroExempt) SURO_EXEMPT = cfg.suroExempt;
                        if (cfg.suroExemptLabel) SURO_EXEMPT_LABEL = cfg.suroExemptLabel;
                        if (cfg.suroExemptNote) SURO_EXEMPT_NOTE = cfg.suroExemptNote;
                        if (cfg.rolePriority) ROLE_PRIORITY = cfg.rolePriority;
                        if (cfg.guildStartDate) GUILD_START_DATE = new Date(cfg.guildStartDate);
                        if (cfg.rowHighlightRoles) ROW_HIGHLIGHT_ROLES = cfg.rowHighlightRoles;
                    }
                } catch(e) { console.warn('site_config ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', e); }

                const members = await fetchAll('members', 'name');
                const periods = await fetchAll('suro_periods', 'id', '*');
                const scores = await fetchAll('suro_scores', 'id', '*');
                const bail = await fetchAll('bail_history', 'id', 'receiver, amount', false);
                const penalty = await fetchAll('penalty_history', 'id', 'points', false);
                const events = await fetchAll('events', 'date', '*', false);

                // Build suro score map
                const scoreMap = {};
                members.forEach(m => scoreMap[m.id] = {});
                scores.forEach(s => {
                    const period = periods.find(p => p.id === s.period_id);
                    if (period && scoreMap[s.member_id]) {
                        scoreMap[s.member_id][period.period_label] = s.score;
                    }
                });

                appState.suroHeaders = periods.map(p => p.period_label);
                appState.members = members.map(m => ({
                    id: String(m.id),
                    name: m.name,
                    guild: m.guild,
                    role: m.role,
                    class: m.class || '',
                    isMain: m.is_main,
                    mainCharName: m.main_char_name || '',
                    joinDate: m.join_date || '',
                    suro: scoreMap[m.id] || {}
                }));
                appState.history = [];
                appState.bailHistory = bail.map(h => ({
                    receiver: h.receiver,
                    amount: h.amount
                }));
                appState.events = events.map(e => ({
                    id: e.id,
                    date: (e.date || '').split('T')[0].trim(),
                    title: e.title,
                    content: e.content
                }));
                appState.penaltyHistory = penalty.map(h => ({
                    name: '******',
                    points: h.points,
                    reason: 'ë¹„ê³µê°œ'
                }));
                appState._penaltyCounts = {};
                penalty.forEach((h, i) => {
                    appState._penaltyCounts['******_' + i] = Number(h.points);
                });
                appState._activePenaltyCount = penalty.length;

                const countEl = document.getElementById('totalMembersCount');
                if (countEl) {
                    const counts = {};
                    appState.guilds.forEach(g => counts[g.name] = 0);
                    appState.members.forEach(m => {
                        if (counts[m.guild] !== undefined) counts[m.guild]++;
                    });
                    
                    const aliases = {};
                    appState.guilds.forEach(g => { aliases[g.name] = g.name.substring(0, 1); });
                    const defaultBadgeStyles = {
                        'ëš ì¹´ë¡±': 'background:#fdf2f8;color:#db2777;border-color:#fbcfe8',
                        'ëš±ì¹´ë¡±': 'background:#fff1f2;color:#e11d48;border-color:#fecdd3',
                        'ë°¤ì¹´ë¡±': 'background:#eef2ff;color:#4f46e5;border-color:#c7d2fe',
                        'ë³„ì¹´ë¡±': 'background:#fefce8;color:#ca8a04;border-color:#fef08a',
                        'ë‹¬ì¹´ë¡±': 'background:#eff6ff;color:#2563eb;border-color:#bfdbfe',
                        'ê¿€ì¹´ë¡±': 'background:#fffbeb;color:#d97706;border-color:#fde68a'
                    };
                    const cfgBadge = SITE_CONFIG?.guildBadgeStyles || {};
                    const guildBadgeStyles = {};
                    appState.guilds.forEach(g => {
                        if (cfgBadge[g.name]) {
                            const b = cfgBadge[g.name];
                            guildBadgeStyles[g.name] = `background:${b.bg};color:${b.text};border-color:${b.border}`;
                        } else {
                            guildBadgeStyles[g.name] = defaultBadgeStyles[g.name] || 'background:#f3f4f6;color:#666';
                        }
                    });

                    countEl.innerHTML = appState.guilds.map(g => {
                        const name = aliases[g.name] || g.name.substring(0, 1);
                        const s = guildBadgeStyles[g.name] || 'background:#f3f4f6;color:#666';
                        return `<span style="${s};border:1px solid;padding:2px 6px;border-radius:6px;font-size:10px;font-weight:900">${name} ${counts[g.name]}</span>`;
                    }).join('');
                }
                window.updateAnniversaryLabel();
            } catch (e) { 
                console.error("Fetch Error:", e); 
                alert("ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨\n\nSupabase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            } finally {
                window.setLoadProgress(100, 'ì™„ë£Œ!');
                setTimeout(() => window.showLoading(false), 300);
                window.router(appState.activeTab);
            }
        };

        window.router = (tab) => {
            appState.activeTab = tab;
            const content = document.getElementById('contentArea'); if(!content) return;
            content.innerHTML = '';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.toggle('active', el.dataset.target === tab));
            const titles = { dashboard: 'ê¸¸ë“œ í˜„í™©íŒ', members: 'ê¸¸ë“œì› ëª©ë¡', analysis: 'ìˆ˜ë¡œ ë¶„ì„', bail: 'ë³´ì„ê¸ˆ í˜„í™©', penalty: 'ë²Œì  í˜„í™©', guide_intro: 'ê¸¸ë“œ ì†Œê°œ', guide_ranks: 'ì§ìœ„ & ë¶€ìº', guide_links: 'ë§í¬ ëª¨ìŒ' };
            document.getElementById('pageTitle').innerText = titles[tab] || '';
            if (tab === 'dashboard') window.renderDashboard(content);
            else if (tab === 'members') window.renderMembers(content);
            else if (tab === 'analysis') window.renderAnalysis(content, appState.analysisGuild);
            else if (tab === 'bail') window.renderBail(content);
            else if (tab === 'penalty') window.renderPenalty(content);
            else if (tab.startsWith('guide_')) window.renderGuide(content, tab.replace('guide_',''));
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            if (window.innerWidth < 1024) { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        };

        window.renderCutoffCards = () => {
            const cutoffs = SITE_CONFIG?.cutoffs || {};
            const guildNames = Object.keys(cutoffs);
            if (guildNames.length === 0) return '<p class="text-xs text-gray-400 col-span-2 text-center py-4">ì»¤íŠ¸ë¼ì¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';

            const guildIcons = { 'ëš ì¹´ë¡±': 'fa-crown', 'ëš±ì¹´ë¡±': 'fa-heart' };
            const guildTitleColors = { 'ëš ì¹´ë¡±': 'text-pink-500', 'ëš±ì¹´ë¡±': 'text-pink-600' };
            const guildIconColors = { 'ëš ì¹´ë¡±': 'text-pink-500', 'ëš±ì¹´ë¡±': 'text-pink-400' };

            return guildNames.map(gName => {
                const items = cutoffs[gName] || [];
                const icon = guildIcons[gName] || 'fa-star';
                const titleColor = guildTitleColors[gName] || 'text-gray-600';
                const iconColor = guildIconColors[gName] || 'text-gray-400';

                const suroExemptIdx = items.findIndex(c => SURO_EXEMPT.includes(c.rank) && !SURO_EXEMPT.includes((items[items.length > 0 ? items.indexOf(c) + 1 : 0] || {}).rank));

                const rowsHtml = items.map((c, idx) => {
                    const rd = ROLE_DISPLAY[c.rank] || {};
                    const emoji = rd.emoji || '';
                    const cssText = c.cssText || 'text-gray-600';
                    const cssValue = c.cssValue || 'text-gray-500';
                    const cssBg = c.cssBg || 'bg-gray-50';
                    const cssBorder = c.cssBorder || 'border-gray-100';
                    const cssGradient = c.cssGradient;
                    const noteHtml = c.note ? ` <span class="text-[9px] text-gray-400">(${c.note})</span>` : '';

                    let rowClass = `${cssBg} border ${cssBorder}`;
                    let rowStyle = '';
                    if (cssGradient) {
                        rowClass = `bg-gradient-to-r ${cssGradient} border ${cssBorder}`;
                    }

                    let exemptNoteHtml = '';
                    if (idx === suroExemptIdx && SURO_EXEMPT_NOTE) {
                        exemptNoteHtml = `</div><div class="text-[9px] text-blue-500 font-bold pl-2.5 -mt-0.5 mb-1 flex items-center gap-1"><i class="fas fa-angle-double-up text-[8px]"></i> ${SURO_EXEMPT_NOTE}`;
                    }

                    return `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg ${rowClass}" style="${rowStyle}"><span class="${cssText}">${emoji} ${c.rank}</span><span class="${cssValue}">${c.label}${noteHtml}</span></div>${exemptNoteHtml}`;
                }).join('');

                return `<div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                    <h3 class="text-[10px] lg:text-xs font-bold ${titleColor} uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas ${icon} ${iconColor}"></i> ${gName} ì§ìœ„ ì»¤íŠ¸ë¼ì¸</h3>
                    <div class="space-y-1.5 text-[10px] lg:text-[11px] font-bold">${rowsHtml}</div>
                </div>`;
            }).join('');
        };

        window.renderDashboard = (container) => {
            const ddunT = window.calculateTotalSuro('ëš ì¹´ë¡±'); 
            const ddungT = window.calculateTotalSuro('ëš±ì¹´ë¡±');
            
            const ddunMembers = appState.members.filter(m => m.guild === 'ëš ì¹´ë¡±');
            const roleCounts = {};
            ddunMembers.forEach(m => { const r = m.role || 'ë¯¸ì„¤ì •'; roleCounts[r] = (roleCounts[r] || 0) + 1; });
            const roleOrder = ['ë§ˆì¹´ë¡±','ë‹¤ì¿ ì•„ì¦ˆ','í¬ë¼ìš´','íŒŒë¥´í˜','í‹°ë¼ë¯¸ìŠˆ','í¬ë¡œì¹¸ìŠˆ','ë¡¤ì¼€ì´í¬','íŒ¬ì¼€ì´í¬','ì™€í”Œ','ìŠ¤ì½˜','ë°˜ì£½','ë°˜ì£½(íœ´ë©´)'];
            const roleEmoji = {'ë§ˆì¹´ë¡±':'ğŸ‘‘','ë‹¤ì¿ ì•„ì¦ˆ':'ğŸ‘‘','í¬ë¼ìš´':'ğŸ‘‘','íŒŒë¥´í˜':'ğŸ¨','í‹°ë¼ë¯¸ìŠˆ':'ğŸ°','í¬ë¡œì¹¸ìŠˆ':'ğŸ¥','ë¡¤ì¼€ì´í¬':'ğŸ¥','íŒ¬ì¼€ì´í¬':'ğŸ¥','ì™€í”Œ':'ğŸ§‡','ìŠ¤ì½˜':'ğŸª','ë°˜ì£½(íœ´ë©´)':'ğŸ«“','ë°˜ì£½':'ğŸ«“'};
            const roleColorClass = {'ë§ˆì¹´ë¡±':'text-blue-600 bg-blue-50 border-blue-100','ë‹¤ì¿ ì•„ì¦ˆ':'text-pink-600 bg-pink-50 border-pink-100','í¬ë¼ìš´':'text-amber-600 bg-amber-50 border-amber-100','íŒŒë¥´í˜':'text-indigo-600 bg-indigo-50 border-indigo-100','í‹°ë¼ë¯¸ìŠˆ':'text-indigo-600 bg-indigo-50 border-indigo-100','í¬ë¡œì¹¸ìŠˆ':'text-green-600 bg-green-50 border-green-100','ë¡¤ì¼€ì´í¬':'text-pink-600 bg-pink-50 border-pink-100','íŒ¬ì¼€ì´í¬':'text-pink-600 bg-pink-50 border-pink-100','ì™€í”Œ':'text-orange-600 bg-orange-50 border-orange-100','ìŠ¤ì½˜':'text-gray-600 bg-gray-50 border-gray-100','ë°˜ì£½(íœ´ë©´)':'text-gray-400 bg-gray-50 border-gray-100','ë°˜ì£½':'text-gray-400 bg-gray-50 border-gray-100'};
            const roleCountHtml = roleOrder.filter(r => roleCounts[r]).map(r => `<div class="flex justify-between items-center py-1.5 px-2.5 rounded-lg border ${roleColorClass[r] || 'bg-gray-50 border-gray-100'}"><span>${roleEmoji[r] || ''} ${r}</span><span class="font-black">${roleCounts[r]}ëª…</span></div>`).join('');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8 fade-in shrink-0">
                <div class="flex flex-col gap-6">
                    <div class="grid grid-cols-2 gap-3 lg:gap-6 h-auto lg:h-40">
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš ì¹´ë¡±')" class="bg-gradient-to-br from-pink-400 to-rose-400 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-lg text-white cursor-pointer hover:scale-[1.02] transition-transform relative overflow-hidden flex flex-col justify-center border-none">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-5xl"><i class="fas fa-crown"></i></div>
                            <h3 class="text-sm font-bold opacity-80 uppercase tracking-widest text-center">ëš ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-center">${ddunT.toLocaleString()}</p>
                        </div>
                        <div onclick="router('analysis'); renderAnalysis(document.getElementById('contentArea'), 'ëš±ì¹´ë¡±')" class="bg-white border border-gray-100 rounded-2xl lg:rounded-[2.5rem] p-4 lg:p-8 shadow-sm text-gray-800 cursor-pointer hover:border-pink-100 transition-all flex flex-col justify-center relative overflow-hidden">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest text-center">ëš±ì¹´ë¡± ìˆ˜ë¡œ ì´ì </h3>
                            <p class="text-3xl font-black tracking-tighter text-pink-600 text-center">${ddungT.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">ğŸ“…</span>
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Guild Calendar</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-2xl border border-gray-100">
                                    <button onclick="moveMonth(-1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-600 transition-all text-gray-400"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                    <span class="text-[11px] font-bold text-gray-600 w-16 text-center">${appState.calendarView.year}.${String(appState.calendarView.month + 1).padStart(2, '0')}</span>
                                    <button onclick="moveMonth(1)" class="w-6 h-6 flex items-center justify-center rounded-lg hover:bg-white hover:text-pink-600 transition-all text-gray-400"><i class="fas fa-chevron-right text-[10px]"></i></button>
                                </div>
                            </div>
                        </div>
                        ${window.renderCalendar()}
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 lg:gap-4">
                        ${window.renderCutoffCards()}
                    </div>
                    <div class="bg-white p-4 lg:p-6 rounded-2xl lg:rounded-[2rem] border border-gray-100 shadow-sm">
                        <h3 class="text-[10px] lg:text-xs font-bold text-pink-600 uppercase tracking-widest mb-3 flex items-center gap-2"><i class="fas fa-users text-pink-500"></i> ëš ì¹´ë¡± ì§ìœ„ë³„ ì¸ì› <span class="text-gray-400 font-bold">(${ddunMembers.length}ëª…)</span></h3>
                        <div class="grid grid-cols-2 gap-1.5 text-[10px] lg:text-[11px] font-bold">${roleCountHtml}</div>
                    </div>
                </div>
                <div class="flex flex-col gap-8 h-full">
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-gray-100 flex flex-col min-h-[300px] overflow-hidden shrink-0">
                        <div class="flex justify-between items-center mb-4 shrink-0">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-chart-bar text-pink-400"></i> ì§ì—… ë¶„í¬ë„</h3>
                            <select onchange="window.updateJobChart(this.value)" class="bg-gray-50 rounded-xl px-3 py-1.5 text-xs font-bold outline-none cursor-pointer hover:bg-gray-100 border border-gray-100">
                                <option value="all">ì „ì²´ë³´ê¸°</option>${appState.guilds.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1 overflow-y-auto no-scrollbar relative">
                            <div id="jobChartContainer" class="flex flex-col gap-4"></div>
                        </div>
                        <button onclick="window.toggleJobChart()" id="jobToggleBtn" class="mt-3 py-2 text-[10px] font-bold text-gray-400 hover:text-pink-600 transition-all flex items-center justify-center gap-1"><i class="fas fa-chevron-down text-[8px]" id="jobToggleIcon"></i> <span id="jobToggleText">ë”ë³´ê¸°</span></button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-3 lg:gap-6 fade-in shrink-0">
                ${appState.guilds.map(g => { 
                    const count = appState.members.filter(m => m.guild === g.name).length; 
                    const pct = Math.min((count / g.max) * 100, 100); 
                    return `<div class="bg-white p-4 lg:p-8 rounded-2xl lg:rounded-[2.5rem] border border-gray-100 shadow-sm hover:shadow-xl transition-all cursor-pointer group" onclick="filterByGuild('${g.name}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-gray-50 rounded-2xl flex items-center justify-center text-gray-400 group-hover:bg-pink-50 group-hover:text-pink-600 transition-colors"><i class="fas ${g.icon}"></i></div><div><span class="block font-bold text-lg text-gray-800 group-hover:text-pink-600">${g.name}</span><span class="text-[10px] text-gray-400 font-bold">${g.type}</span></div></div></div><div class="w-full bg-gray-50 rounded-full h-1.5 overflow-hidden"><div class="h-full bg-pink-500 transition-all duration-1000" style="width:${pct}%"></div></div><p class="text-[10px] text-gray-400 font-bold mt-2 text-right">${count} / ${g.max}</p></div>`; 
                }).join('')}
            </div>`;
            setTimeout(() => window.updateJobChart('all'), 0);
        };

        window.moveMonth = (delta) => {
            let newMonth = appState.calendarView.month + delta;
            let newYear = appState.calendarView.year;
            if (newMonth < 0) { newMonth = 11; newYear--; }
            else if (newMonth > 11) { newMonth = 0; newYear++; }
            appState.calendarView.month = newMonth;
            appState.calendarView.year = newYear;
            window.router('dashboard');
        };

        window.renderCalendar = () => { 
            const year = appState.calendarView.year, month = appState.calendarView.month; 
            const first = new Date(year, month, 1).getDay();
            const last = new Date(year, month + 1, 0).getDate(); 
            const prevLast = new Date(year, month, 0).getDate();
            const today = new Date();
            
            let html = `<div class="calendar-grid"><div class="calendar-head text-red-400">ì¼</div><div class="calendar-head">ì›”</div><div class="calendar-head">í™”</div><div class="calendar-head">ìˆ˜</div><div class="calendar-head text-pink-500">ëª©</div><div class="calendar-head">ê¸ˆ</div><div class="calendar-head text-blue-400">í† </div>`; 
            
            for(let i=first; i>0; i--) {
                html += `<div class="calendar-day not-current"><span>${prevLast - i + 1}</span></div>`;
            }

            for(let d=1; d<=last; d++) { 
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayEvents = appState.events.filter(e => {
                    const eDate = (e.date || '').split('T')[0].trim();
                    return eDate === dateStr;
                });
                
                const isToday = today.getFullYear()===year && today.getMonth()===month && today.getDate()===d;
                const isThursday = new Date(year, month, d).getDay() === 4;

                let cls = "calendar-day text-gray-600";
                if(isThursday) cls += " thursday";
                if(isToday) cls += " today";
                
                let eventHtml = '';
                if(dayEvents.length > 0) {
                    eventHtml += `<div class="event-dot"></div>`;
                    dayEvents.slice(0, 2).forEach(e => {
                        eventHtml += `<div class="event-snippet" title="${e.title}">${e.title}</div>`;
                    });
                    if (dayEvents.length > 2) eventHtml += `<div class="text-[9px] text-pink-400 mt-0.5 leading-none font-bold">+${dayEvents.length - 2}</div>`;
                }
                html += `<div class="${cls}" onclick="window.showEventDetail('${dateStr}')"><span>${d}</span>${eventHtml}</div>`; 
            } 
            
            const totalCells = first + last;
            const extraCells = (7 - (totalCells % 7)) % 7;
            for(let i=1; i<=extraCells; i++) {
                html += `<div class="calendar-day not-current"><span>${i}</span></div>`;
            }

            return html + `</div>`; 
        };

        window.showEventDetail = (dateStr) => {
            appState.currentSelectedDate = dateStr;
            const modal = document.getElementById('eventDetailModal');
            document.getElementById('eventDetailDate').innerText = dateStr;
            
            const dayEvents = appState.events.filter(e => e.date === dateStr);
            const listContainer = document.getElementById('eventListForDate');
            listContainer.innerHTML = '';
            
            if (dayEvents.length > 0) {
                dayEvents.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'p-4 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold text-gray-600 space-y-1';
                    item.innerHTML = `<div class="text-pink-600 text-sm">${e.title}</div>${e.content ? `<div class="text-gray-400 text-[11px] whitespace-pre-wrap">${e.content}</div>` : ''}`;
                    listContainer.appendChild(item);
                });
            } else {
                listContainer.innerHTML = `<p class="text-xs text-gray-400 text-center py-4">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = (id) => { document.getElementById(id)?.classList.add('hidden'); };

        window.changePage = (type, delta) => {
            appState.pagination[type] += delta;
            if (type === 'members') window.updateMemberTable();
        };

        window._analysisSearchTimer = null;
        window.setAnalysisSearch = (val) => {
            appState.analysisFilters.search = val;
            if (window._analysisSearchTimer) clearTimeout(window._analysisSearchTimer);
            window._analysisSearchTimer = setTimeout(() => { window.updateAnalysisTable(); }, 200);
        };

        window.updateAnalysisTable = () => {
            const tbody = document.getElementById('analysisTableBody');
            if (!tbody) return;
            const gName = appState.analysisGuild;
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) : [];
            const displayTargets = searchTokens.length > 0
                ? guildTargets.filter(m => { const mn = m.isMain ? m.name : (m.mainCharName||''); return searchTokens.some(t => m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t)); })
                : guildTargets;
            const recentHeaders = [...appState.suroHeaders];
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;
            const processedList = displayTargets.map(m => { const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0); const vs = scores.filter(s => s > 0); return { ...m, avg: vs.length > 0 ? Math.round(vs.reduce((a,b)=>a+b,0)/vs.length) : 0, recentScores: scores }; });
            const f = appState.analysisFilters.sortField, o = appState.analysisFilters.sortOrder;
            processedList.sort((a,b) => { if(f.startsWith('date_')){const th=f.replace('date_',''),hi=recentHeaders.indexOf(th),ph=hi>0?recentHeaders[hi-1]:null;const rate=(m)=>{const c=Math.round(Number(m.suro?.[th]))||0;if(!ph)return c>0?-500:-1000;const p=Math.round(Number(m.suro?.[ph]))||0;if(c===0&&p===0)return-1000;if(p===0&&c>0)return-500;return((c-p)/p)*100;};const rA=rate(a),rB=rate(b);if(rA===rB){const cA=Math.round(Number(a.suro?.[th]))||0,cB=Math.round(Number(b.suro?.[th]))||0;return o==='asc'?cA-cB:cB-cA;}return o==='asc'?rA-rB:rB-rA;}if(f==='avg')return o==='asc'?a.avg-b.avg:b.avg-a.avg;if(f==='score'){const vA=Math.round(Number(a.suro?.[currentHeader]))||0,vB=Math.round(Number(b.suro?.[currentHeader]))||0;return o==='asc'?vA-vB:vB-vA;}return smartCompare(a,b,f,o); });
            tbody.innerHTML = processedList.map((m,i) => { let row = `<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50"><td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50">${i+1}</td><td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white"><div class="flex items-center leading-none overflow-hidden text-ellipsis">${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div></div></td><td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>`; m.recentScores.forEach((s,si) => { let dh='',ps=si>0?m.recentScores[si-1]:0; if(s>0||(s===0&&ps>0)){if(ps>0){const dp=((s-ps)/ps*100);if(s>ps)dh=`<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² ${dp.toFixed(1)}%</span>`;else if(s<ps)dh=`<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">â–¼ ${Math.abs(dp).toFixed(1)}%</span>`;else dh=`<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;}else if(s>0)dh=`<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² NEW</span>`;}row+=`<td class="p-3 min-w-[100px] text-right font-mono align-middle ${s===0?'bg-red-50/20 text-red-400 group-hover:bg-red-50/50':'bg-white text-gray-700 group-hover:bg-gray-50'}"><div class="flex flex-col justify-center items-end leading-tight min-h-[28px]"><span class="${s>0?'text-xs':'text-gray-400'}">${s>0?s.toLocaleString():'0'}</span>${dh}</div></td>`; }); return row + '</tr>'; }).join('');
        };

        window.renderAnalysis = (container, gName) => {
            appState.analysisGuild = gName;
            
            const guildTargets = appState.members.filter(m => m.guild === gName);
            const rawSearch = (appState.analysisFilters.search || '').trim();
            const searchTokens = rawSearch.length > 0 ? rawSearch.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0) : [];
            const displayTargets = searchTokens.length > 0
                ? guildTargets.filter(m => { const mn = m.isMain ? m.name : (m.mainCharName||''); return searchTokens.some(t => m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t)); })
                : guildTargets;
            
            const getWedStr = (h) => {
                if (!h) return '';
                const p = h.split('~');
                return p.length > 1 ? p[1].replace('ìˆ˜ë¡œ ì ìˆ˜', '').trim() : h.trim();
            };
            const getShortWedStr = (h) => {
                const str = getWedStr(h);
                const p = str.split('-');
                return p.length >= 3 ? p[1] + '-' + p[2].substring(0,2) : str;
            };

            const recentHeaders = [...appState.suroHeaders]; 
            const currentHeader = recentHeaders.length > 0 ? recentHeaders[recentHeaders.length - 1] : null;

            const displayTotal = currentHeader ? guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[currentHeader])) || 0), 0) : 0;
            const zeroPointMembers = currentHeader ? guildTargets.filter(m => (Math.round(Number(m.suro?.[currentHeader])) || 0) === 0) : [];
            
            const processedList = displayTargets.map(m => {
                const scores = recentHeaders.map(h => Math.round(Number(m.suro?.[h])) || 0);
                const validScores = scores.filter(s => s > 0);
                const avg = validScores.length > 0 ? Math.round(validScores.reduce((a, b) => a + b, 0) / validScores.length) : 0;
                return { ...m, avg: avg, recentScores: scores };
            });

            let topScores = [];
            let scoreIncreases = [];
            let pctIncreases = [];
            let avgIncreases = [];

            if (recentHeaders.length >= 2 && currentHeader) {
                const prevHeader = recentHeaders[recentHeaders.length - 2];
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    const prevScore = Math.round(Number(m.suro?.[prevHeader])) || 0;
                    
                    const pastScores = recentHeaders.slice(0, -1).map(h => Math.round(Number(m.suro?.[h])) || 0).filter(s => s > 0);
                    const pastAvg = pastScores.length > 0 ? Math.round(pastScores.reduce((a,b)=>a+b,0) / pastScores.length) : 0;

                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }

                    if (prevScore > 0 && currScore > prevScore) {
                        const increase = currScore - prevScore;
                        const increasePct = (increase / prevScore) * 100;
                        scoreIncreases.push({ name: m.name, val: increase, role: m.role });
                        pctIncreases.push({ name: m.name, val: increasePct, role: m.role });
                    }
                    
                    if (pastAvg > 0 && currScore > pastAvg) {
                        const aboveAvg = currScore - pastAvg;
                        avgIncreases.push({ name: m.name, val: aboveAvg, role: m.role });
                    }
                });
            } else if (currentHeader) {
                guildTargets.forEach(m => {
                    const currScore = Math.round(Number(m.suro?.[currentHeader])) || 0;
                    if (currScore > 0) {
                        topScores.push({ name: m.name, val: currScore, role: m.role });
                    }
                });
            }

            topScores.sort((a,b) => b.val - a.val);
            scoreIncreases.sort((a,b) => b.val - a.val);
            pctIncreases.sort((a,b) => b.val - a.val);
            avgIncreases.sort((a,b) => b.val - a.val);

            const topScoreHighMVP = topScores.slice(0, 5);
            const topScoreMVP = scoreIncreases.slice(0, 5);
            const topPctMVP = pctIncreases.slice(0, 5);
            const topAvgMVP = avgIncreases.slice(0, 5);

            window._mvpFullData = { high: topScores, score: scoreIncreases, pct: pctIncreases, avg: avgIncreases };

            processedList.sort((a, b) => {
                const f = appState.analysisFilters.sortField;
                const o = appState.analysisFilters.sortOrder;
                
                if (f.startsWith('date_')) {
                    const targetHeader = f.replace('date_', '');
                    const headerIdx = recentHeaders.indexOf(targetHeader);
                    const prevHeader = headerIdx > 0 ? recentHeaders[headerIdx - 1] : null;

                    const getIncRate = (m) => {
                        const curr = Math.round(Number(m.suro?.[targetHeader])) || 0;
                        if (!prevHeader) return curr > 0 ? -500 : -1000;
                        const prev = Math.round(Number(m.suro?.[prevHeader])) || 0;
                        if (curr === 0 && prev === 0) return -1000; 
                        if (prev === 0 && curr > 0) return -500; 
                        return ((curr - prev) / prev) * 100;
                    };

                    const rateA = getIncRate(a);
                    const rateB = getIncRate(b);
                    
                    if (rateA === rateB) {
                        const currA = Math.round(Number(a.suro?.[targetHeader])) || 0;
                        const currB = Math.round(Number(b.suro?.[targetHeader])) || 0;
                        return o === 'asc' ? currA - currB : currB - currA;
                    }
                    return o === 'asc' ? rateA - rateB : rateB - rateA;
                }

                if (f === 'avg') return o === 'asc' ? a.avg - b.avg : b.avg - a.avg;
                if (f === 'score') {
                    const vA = Math.round(Number(a.suro?.[currentHeader])) || 0;
                    const vB = Math.round(Number(b.suro?.[currentHeader])) || 0;
                    return o === 'asc' ? vA - vB : vB - vA;
                }
                return smartCompare(a, b, f, o);
            });

            const sortIcon = (f) => appState.analysisFilters.sortField === f ? (appState.analysisFilters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            const analysisGuildsOptions = ['ëš ì¹´ë¡±', 'ëš±ì¹´ë¡±'];
            
            const renderMvpList = (list, type) => {
                if(list.length === 0) return `<div class="flex items-center justify-center h-full pb-2"><span class="text-[10px] text-gray-400 font-bold">ë°ì´í„° ë¶€ì¡±</span></div>`;
                
                let colorBase = '';
                if(type === 'high') colorBase = 'blue';
                else if(type === 'score') colorBase = 'orange';
                else if(type === 'pct') colorBase = 'emerald';
                else if(type === 'avg') colorBase = 'purple';

                return `<div class="flex flex-col gap-1.5 z-10 w-full mt-2">
                    ${list.map((m, idx) => {
                        let displayVal = '';
                        if(type === 'high') displayVal = Math.round(m.val).toLocaleString();
                        else if(type === 'score') displayVal = '+' + Math.round(m.val).toLocaleString();
                        else if(type === 'pct') displayVal = 'â–²' + m.val.toFixed(1) + '%';
                        else if(type === 'avg') displayVal = '+' + Math.round(m.val).toLocaleString();

                        return `<div class="flex justify-between items-center text-[10px] leading-none bg-white/40 rounded px-1.5 py-1">
                            <div class="flex items-center gap-1.5 overflow-hidden">
                                <span class="font-black text-${colorBase}-500 inline-block w-2.5 text-center">${idx+1}</span>
                                <span class="font-bold text-gray-800 truncate" style="max-width: 60px;" title="${m.name}">${m.name}</span>
                            </div>
                            <span class="font-black text-${colorBase}-600 shrink-0">${displayVal}</span>
                        </div>`;
                    }).join('')}
                </div>`;
            };

            container.innerHTML = `
            <div class="flex flex-col fade-in h-full">
                <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ê³ ì •) -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 shrink-0 pb-3 bg-gray-50 z-20">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar shrink-0 w-full sm:w-auto">
                        ${analysisGuildsOptions.map(gNameOption => `<button onclick="window.renderAnalysis(document.getElementById('contentArea'), '${gNameOption}')" class="px-6 py-2.5 rounded-xl text-xs font-bold transition-all shrink-0 ${gNameOption === gName ? 'bg-pink-500 text-white shadow-lg' : 'bg-white text-gray-500 border border-gray-100'}">${gNameOption}</button>`).join('')}
                    </div>
                    <div class="relative w-full sm:w-64 shrink-0">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.setAnalysisSearch(this.value)" value="${appState.analysisFilters.search || ''}" class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-100 rounded-xl outline-none text-xs font-bold shadow-sm focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„/ë³¸ìº/ì§ì—… ê²€ìƒ‰ (ë‹¤ì¤‘ê²€ìƒ‰)">
                    </div>
                </div>

                <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
                <div class="flex-1 overflow-y-auto min-h-0 flex flex-col gap-3">

                <!-- â˜… ìƒë‹¨ ìš”ì•½ í•œ ì¤„ -->
                <div class="grid grid-cols-3 gap-2 shrink-0 font-bold">
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">ì „ì²´ ì´ì </span>
                        <span class="text-base font-black text-gray-800 tracking-tighter">${displayTotal.toLocaleString()}</span>
                    </div>
                    <div class="bg-red-50 py-2.5 px-4 rounded-xl border border-red-100 shadow-sm flex items-center justify-center gap-3">
                        <span class="text-[8px] text-red-500 uppercase tracking-widest">ğŸš¨ ë¯¸ì°¸ì—¬</span>
                        <span class="text-base font-black text-red-600">${zeroPointMembers.length}ëª…</span>
                    </div>
                    <div class="bg-white py-2.5 px-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center gap-3 cursor-pointer group" onclick="window.expandChart()">
                        <span class="text-[8px] text-gray-400 uppercase tracking-widest">ìµœê·¼ ì£¼ì°¨</span>
                        <span class="text-sm font-bold text-gray-700">${currentHeader ? getWedStr(currentHeader) : 'ì—†ìŒ'}</span>
                        <span class="text-[8px] text-gray-300 group-hover:text-pink-400"><i class="fas fa-chart-line"></i></span>
                    </div>
                </div>
                <canvas id="analysisChart" style="display:none;"></canvas>

                <!-- â˜… MVP 4ê°œ í•œ ì¤„ -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-2 font-bold shrink-0">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-blue-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('high')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-blue-500"><i class="fas fa-crown"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-blue-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-star"></i> ì´ë²ˆ ì£¼ ê³ ë“ì </p><span class="text-[8px] text-blue-300 group-hover/mvp:text-blue-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreHighMVP, 'high')}
                        </div>
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-orange-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('score')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-orange-500"><i class="fas fa-trophy"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-orange-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-arrow-trend-up"></i> ì ìˆ˜ ë–¡ìƒ</p><span class="text-[8px] text-orange-300 group-hover/mvp:text-orange-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topScoreMVP, 'score')}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-emerald-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('pct')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-emerald-500"><i class="fas fa-chart-line"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-emerald-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-percent"></i> ìƒìŠ¹ë¥ </p><span class="text-[8px] text-emerald-300 group-hover/mvp:text-emerald-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topPctMVP, 'pct')}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-fuchsia-50 p-2.5 lg:p-3.5 rounded-xl lg:rounded-2xl border border-purple-100 shadow-sm flex flex-col relative overflow-hidden h-full min-h-[85px] lg:min-h-[100px] cursor-pointer group/mvp" onclick="window.expandMvp('avg')">
                            <div class="absolute -right-2 -bottom-2 opacity-[0.05] text-4xl lg:text-6xl text-purple-500"><i class="fas fa-bolt"></i></div>
                            <div class="flex justify-between items-center z-10"><p class="text-[8px] lg:text-[9px] text-purple-600 font-bold uppercase tracking-widest flex items-center gap-1"><i class="fas fa-balance-scale"></i> í‰ê· ëŒ€ë¹„ ë–¡ìƒ</p><span class="text-[8px] text-purple-300 group-hover/mvp:text-purple-500 transition-colors"><i class="fas fa-expand-alt"></i></span></div>
                            ${renderMvpList(topAvgMVP, 'avg')}
                        </div>
                </div>

                <!-- â˜… ì „ì²´ ë°ì´í„° í…Œì´ë¸” (ì „ì²´ ë„ˆë¹„) -->
                <div class="min-h-[80vh]">
                    <div class="bg-white rounded-xl lg:rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden h-full relative">
                        <div class="p-3 lg:p-4 border-b border-gray-50 flex justify-between items-center shrink-0 bg-white relative z-40">
                            <h3 class="text-[10px] lg:text-xs font-bold text-gray-800 uppercase tracking-widest">ì „ì²´ ë°ì´í„° (ëˆ„ì )</h3>
                            <button onclick="window.expandTable()" class="text-[9px] text-gray-300 hover:text-pink-400 transition-colors flex items-center gap-1 font-bold"><i class="fas fa-expand-alt"></i> í™•ëŒ€</button>
                        </div>
                        <div id="analysisTableWrapper" class="analysis-table-wrap flex-1 overflow-auto bg-white scroll-smooth relative">
                            <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                                <thead class="text-[10px] text-gray-500 uppercase bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th>
                                        <th class="p-3 sortable cursor-pointer hover:bg-gray-200 min-w-[140px] bg-gray-50" onclick="window.setAnalysisSort('name')">ìºë¦­í„°ëª…${sortIcon('name')}</th>
                                        <th class="p-3 text-center sortable bg-pink-50 text-pink-600 cursor-pointer min-w-[110px]" onclick="window.setAnalysisSort('avg')">í‰ê·  (ì°¸ì—¬)${sortIcon('avg')}</th>
                                        ${recentHeaders.map((h, idx) => {
                                            const displayStr = getWedStr(h);
                                            return `<th class="p-3 min-w-[100px] text-right font-medium cursor-pointer hover:bg-gray-200 transition-colors select-none" onclick="window.setAnalysisSort('date_${h}')" title="í´ë¦­í•˜ì—¬ ìƒìŠ¹ë¥  ìˆœìœ¼ë¡œ ì •ë ¬">${displayStr}${sortIcon('date_'+h)}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody id="analysisTableBody" class="font-bold text-gray-700">
                                    ${processedList.map((m, i) => {
                                        const globalIndex = i + 1;
                                        return `
                                        <tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50">
                                            <td class="p-3 text-center text-gray-400 group-hover:bg-gray-50 border-r border-gray-50 bg-white">${globalIndex}</td>
                                            <td class="p-3 text-gray-800 group-hover:bg-gray-50 border-r border-gray-50 bg-white">
                                                <div class="flex items-center leading-none overflow-hidden text-ellipsis">
                                                    ${window.getNicknameIcon(m.role)}<div class="flex flex-col min-w-0"><span class="truncate">${m.name}</span><span class="text-[9px] text-gray-400 font-medium truncate">${m.class||''}</span></div>
                                                </div>
                                            </td>
                                            <td class="p-3 text-center text-pink-600 bg-pink-50/30 group-hover:bg-pink-100 border-r border-pink-50">${m.avg.toLocaleString()}</td>
                                            ${m.recentScores.map((s, scoreIdx) => {
                                                let diffHtml = '';
                                                let prevScore = 0;
                                                
                                                if (scoreIdx > 0) {
                                                    prevScore = m.recentScores[scoreIdx - 1];
                                                }

                                                if (s > 0 || (s === 0 && prevScore > 0)) {
                                                    if (prevScore > 0) {
                                                        const diffPct = ((s - prevScore) / prevScore * 100);
                                                        if (s > prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² ${diffPct.toFixed(1)}%</span>`;
                                                        } else if (s < prevScore) {
                                                            diffHtml = `<span class="text-[9px] text-blue-500 font-bold tracking-tighter block mt-0.5">â–¼ ${Math.abs(diffPct).toFixed(1)}%</span>`;
                                                        } else {
                                                            diffHtml = `<span class="text-[9px] text-gray-400 font-bold tracking-tighter block mt-0.5">- 0.0%</span>`;
                                                        }
                                                    } else if (s > 0) {
                                                        diffHtml = `<span class="text-[9px] text-red-500 font-bold tracking-tighter block mt-0.5">â–² NEW</span>`;
                                                    }
                                                }

                                                return `
                                                <td class="p-3 min-w-[100px] text-right font-mono align-middle ${s === 0 ? 'bg-red-50/20 text-red-400 group-hover:bg-red-50/50' : 'bg-white text-gray-700 group-hover:bg-gray-50'}">
                                                    <div class="flex flex-col justify-center items-end leading-tight min-h-[28px]">
                                                        <span class="${s > 0 ? 'text-xs' : 'text-gray-400'}">${s > 0 ? s.toLocaleString() : '0'}</span>
                                                        ${diffHtml}
                                                    </div>
                                                </td>
                                                `;
                                            }).join('')}
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                </div>
            </div>`;

            setTimeout(() => {
                const tableWrapper = document.getElementById('analysisTableWrapper');
                if (tableWrapper) {
                    tableWrapper.scrollLeft = tableWrapper.scrollWidth;
                }
            }, 100);

            const ctx = document.getElementById('analysisChart');
            if(!ctx) return;
            if(analysisChartInstance) analysisChartInstance.destroy();
            analysisChartInstance = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: recentHeaders.map(h => getShortWedStr(h)), 
                    datasets: [{ 
                        label: 'ê¸¸ë“œ ì´ì ', 
                        data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)), 
                        borderColor: '#ec4899', 
                        borderWidth: 3, 
                        pointRadius: 4, 
                        pointBackgroundColor: '#fff', 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(236, 72, 153, 0.05)' 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        y: { display: false }, 
                        x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } } 
                    } 
                } 
            });

            window.expandMvp = (type) => {
                var data = (window._mvpFullData && window._mvpFullData[type]) || [];
                if (data.length === 0) return;
                var titles = { high: 'ì´ë²ˆ ì£¼ ê³ ë“ì  ì „ì²´ ë­í‚¹', score: 'ì ìˆ˜ ë–¡ìƒ ì „ì²´ ë­í‚¹', pct: 'ìƒìŠ¹ë¥  ì „ì²´ ë­í‚¹', avg: 'í‰ê· ëŒ€ë¹„ ë–¡ìƒ ì „ì²´ ë­í‚¹' };
                var colors = { high: ['blue','from-blue-50 to-cyan-50','border-blue-100'], score: ['orange','from-yellow-50 to-orange-50','border-orange-100'], pct: ['emerald','from-emerald-50 to-teal-50','border-emerald-100'], avg: ['purple','from-purple-50 to-fuchsia-50','border-purple-100'] };
                var c = colors[type] || colors.high;
                var formatVal = function(m) { if(type==='high') return Math.round(m.val).toLocaleString(); if(type==='score') return '+'+Math.round(m.val).toLocaleString(); if(type==='pct') return '\u25B2'+m.val.toFixed(1)+'%'; if(type==='avg') return '+'+Math.round(m.val).toLocaleString(); return m.val; };
                var overlay = document.createElement('div');
                overlay.id = 'mvpModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = function(e) { if(e.target === overlay) overlay.remove(); };
                var modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:480px;max-height:80vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';
                modal.innerHTML = '<div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0 bg-gradient-to-r '+c[1]+'"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">'+titles[type]+'</h3><button onclick="document.getElementById(\'mvpModal\').remove()" class="w-8 h-8 rounded-full bg-white/60 hover:bg-white flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button></div><div class="flex-1 overflow-y-auto p-4 space-y-1">' + data.map(function(m,i){ return '<div class="flex justify-between items-center py-2 px-3 rounded-xl '+(i<3?'bg-gradient-to-r '+c[1]+' border '+c[2]:i%2===0?'bg-gray-50':'')+' transition-colors"><div class="flex items-center gap-3 overflow-hidden"><span class="font-black text-'+c[0]+'-500 w-7 text-center text-sm '+(i<3?'':'text-gray-400')+'">'+(i+1)+'</span><div class="flex items-center gap-1.5">'+window.getNicknameIcon(m.role)+'<span class="font-bold text-gray-800 text-sm truncate" style="max-width:180px;">'+m.name+'</span></div></div><span class="font-black text-'+c[0]+'-600 text-sm shrink-0 '+(i>=3?'text-gray-600':'')+'">'+formatVal(m)+'</span></div>'; }).join('') + '</div><div class="p-3 border-t border-gray-100 text-center shrink-0"><span class="text-[10px] text-gray-400 font-bold">\uCD1D '+data.length+'\uBA85</span></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
            };

            window.expandTable = () => {
                var ex = document.getElementById('tableModal'); if(ex) ex.remove();
                var overlay = document.createElement('div');
                overlay.id = 'tableModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:0.75rem;';
                overlay.onclick = function(e){ if(e.target===overlay) overlay.remove(); };
                var modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;width:100%;max-width:95vw;height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);display:flex;flex-direction:column;overflow:hidden;';
                var gName = appState.analysisGuild;
                var guildTargets = appState.members.filter(function(m){ return m.guild===gName; });
                var recentHeaders = [].concat(appState.suroHeaders);
                var getWedStr = function(h){ var m2=h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2?m2[4]+'/'+m2[5]+'/'+m2[6]:h; };
                var modalSort = { field: appState.analysisFilters.sortField, order: appState.analysisFilters.sortOrder };
                var modalSearch = '';
                function renderModalTable(){
                    var searchTokens = modalSearch.length>0 ? modalSearch.toLowerCase().split(/[\s,]+/).filter(function(t){return t.length>0;}) : [];
                    var filtered = searchTokens.length>0 ? guildTargets.filter(function(m){ var mn=m.isMain?m.name:(m.mainCharName||''); return searchTokens.some(function(t){ return m.name.toLowerCase().includes(t)||mn.toLowerCase().includes(t)||(m.mainCharName||'').toLowerCase().includes(t)||(m.class||'').toLowerCase().includes(t); }); }) : guildTargets;
                    var currentHeader = recentHeaders.length>0?recentHeaders[recentHeaders.length-1]:null;
                    var processed = filtered.map(function(m){ var scores=recentHeaders.map(function(h){return Math.round(Number(m.suro&&m.suro[h]))||0;}); var vs=scores.filter(function(s){return s>0;}); return Object.assign({},m,{avg:vs.length>0?Math.round(vs.reduce(function(a,b){return a+b;},0)/vs.length):0,recentScores:scores}); });
                    var f=modalSort.field, o=modalSort.order;
                    processed.sort(function(a,b){
                        if(f.startsWith('date_')){var th=f.replace('date_',''),hi=recentHeaders.indexOf(th),ph=hi>0?recentHeaders[hi-1]:null;var rate=function(m){var c=Math.round(Number(m.suro&&m.suro[th]))||0;if(!ph)return c>0?-500:-1000;var p=Math.round(Number(m.suro&&m.suro[ph]))||0;if(c===0&&p===0)return-1000;if(p===0&&c>0)return-500;return((c-p)/p)*100;};var rA=rate(a),rB=rate(b);if(rA===rB){var cA=Math.round(Number(a.suro&&a.suro[th]))||0,cB=Math.round(Number(b.suro&&b.suro[th]))||0;return o==='asc'?cA-cB:cB-cA;}return o==='asc'?rA-rB:rB-rA;}
                        if(f==='avg')return o==='asc'?a.avg-b.avg:b.avg-a.avg;
                        if(f==='score'){var vA=Math.round(Number(a.suro&&a.suro[currentHeader]))||0,vB=Math.round(Number(b.suro&&b.suro[currentHeader]))||0;return o==='asc'?vA-vB:vB-vA;}
                        return o==='asc'?String(a.name).localeCompare(String(b.name)):String(b.name).localeCompare(String(a.name));
                    });
                    var si=function(col){return modalSort.field===col?(modalSort.order==='asc'?' \u25B2':' \u25BC'):'';};
                    var thead=document.getElementById('modalTableHead');
                    var tbody=document.getElementById('modalTableBody');
                    if(thead) thead.innerHTML='<tr><th class="p-3 text-center min-w-[50px] bg-gray-50">RANK</th><th class="p-3 min-w-[140px] cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort(\'name\')">\uCE90\uB9AD\uD130\uBA85'+si('name')+'</th><th class="p-3 text-center min-w-[110px] cursor-pointer bg-pink-50 text-pink-600 hover:bg-pink-100" onclick="window._modalSort(\'avg\')">\uD3C9\uADE0 (\uCC38\uC5EC)'+si('avg')+'</th>'+recentHeaders.map(function(h){return '<th class="p-3 min-w-[100px] text-right cursor-pointer hover:bg-gray-200 bg-gray-50" onclick="window._modalSort(\'date_'+h+'\')">'+getWedStr(h)+si('date_'+h)+'</th>';}).join('')+'</tr>';
                    if(tbody) tbody.innerHTML=processed.map(function(m,i){
                        var row='<tr class="group h-11 hover:bg-gray-50 transition-colors border-b border-gray-50"><td class="p-3 text-center text-gray-400 bg-white">'+(i+1)+'</td><td class="p-3 text-gray-800 bg-white"><div class="flex items-center leading-none">'+window.getNicknameIcon(m.role)+'<div class="flex flex-col min-w-0"><span class="truncate">'+m.name+'</span><span class="text-[9px] text-gray-400 font-medium truncate">'+(m.class||'')+'</span></div></div></td><td class="p-3 text-center text-pink-600 bg-pink-50/30">'+m.avg.toLocaleString()+'</td>';
                        m.recentScores.forEach(function(s,si2){var dh='',ps=si2>0?m.recentScores[si2-1]:0;if(s>0||(s===0&&ps>0)){if(ps>0){var dp=((s-ps)/ps*100);if(s>ps)dh='<span class="text-[9px] text-red-500 font-bold block mt-0.5">\u25B2 '+dp.toFixed(1)+'%</span>';else if(s<ps)dh='<span class="text-[9px] text-blue-500 font-bold block mt-0.5">\u25BC '+Math.abs(dp).toFixed(1)+'%</span>';else dh='<span class="text-[9px] text-gray-400 font-bold block mt-0.5">- 0.0%</span>';}else if(s>0)dh='<span class="text-[9px] text-red-500 font-bold block mt-0.5">\u25B2 NEW</span>';}row+='<td class="p-3 min-w-[100px] text-right font-mono '+(s===0?'bg-red-50/20 text-red-400':'text-gray-700')+'"><div class="flex flex-col items-end leading-tight min-h-[28px]"><span class="'+(s>0?'text-xs':'text-gray-400')+'">'+(s>0?s.toLocaleString():'0')+'</span>'+dh+'</div></td>';});
                        return row+'</tr>';
                    }).join('');
                }
                window._modalSort=function(col){if(modalSort.field===col){modalSort.order=modalSort.order==='asc'?'desc':'asc';}else{modalSort.field=col;modalSort.order=(col==='avg'||col==='score'||col.startsWith('date_'))?'desc':'asc';}renderModalTable();};
                modal.innerHTML='<div style="padding:1rem 1.25rem;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;gap:1rem;"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest shrink-0">\uC804\uCCB4 \uB370\uC774\uD130 \u2014 '+gName+'</h3><div class="flex items-center gap-2 flex-1 max-w-md"><div class="flex-1 relative"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-300 text-xs"></i><input id="modalSearchInput" type="text" class="w-full pl-8 pr-3 py-2 bg-gray-50 border border-gray-100 rounded-xl text-xs font-bold outline-none focus:ring-2 focus:ring-pink-100" placeholder="\uB2C9\uB124\uC784/\uBCF8\uCE90/\uC9C1\uC5C5 \uAC80\uC0C9" oninput="clearTimeout(window._mst);window._mst=setTimeout(function(){window._modalSearchFn(document.getElementById(\'modalSearchInput\').value)},150)"></div><button onclick="document.getElementById(\'tableModal\').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors shrink-0"><i class="fas fa-times"></i></button></div></div><div style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch;" class="no-scrollbar"><table class="w-full text-left text-xs whitespace-nowrap font-bold stick-head"><thead id="modalTableHead" class="text-[10px] text-gray-500 uppercase border-b border-gray-200 bg-gray-50"></thead><tbody id="modalTableBody" class="text-gray-700"></tbody></table></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                window._modalSearchFn=function(v){modalSearch=v.trim();renderModalTable();};
                renderModalTable();
                var scrollDiv=modal.querySelector('[style*="overflow:auto"]');
                if(scrollDiv) scrollDiv.scrollLeft=scrollDiv.scrollWidth;
            };

            window.expandChart = () => {
                const gName = appState.analysisGuild;
                const guildTargets = appState.members.filter(m => m.guild === gName);
                const recentHeaders = [...appState.suroHeaders];
                const getShortWedStr = (h) => { const m2 = h.match(/(\d+)-(\d+)-(\d+)\(.\)\s*~\s*(\d+)-(\d+)-(\d+)/); return m2 ? m2[4]+'/'+m2[5]+'/'+m2[6] : h; };

                const overlay = document.createElement('div');
                overlay.id = 'chartModal';
                overlay.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:1rem;';
                overlay.onclick = (e) => { if(e.target === overlay) overlay.remove(); };

                const modal = document.createElement('div');
                modal.style.cssText = 'background:white;border-radius:1.5rem;padding:1.5rem;width:100%;max-width:900px;max-height:90vh;box-shadow:0 25px 50px rgba(0,0,0,0.25);position:relative;';
                modal.innerHTML = '<div class="flex justify-between items-center mb-4"><h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ì£¼ê°„ ì´ì  ì¶”ì´ â€” ' + gName + '</h3><button onclick="document.getElementById(\'chartModal\').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition-colors"><i class="fas fa-times"></i></button></div><div style="height:400px;position:relative;"><canvas id="expandedChart"></canvas></div>';
                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                setTimeout(() => {
                    const ctx2 = document.getElementById('expandedChart');
                    if(!ctx2) return;
                    new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: recentHeaders.map(h => getShortWedStr(h)),
                            datasets: [{
                                label: 'ê¸¸ë“œ ì´ì ',
                                data: recentHeaders.map(h => guildTargets.reduce((s, m) => s + (Math.round(Number(m.suro?.[h])) || 0), 0)),
                                borderColor: '#ec4899', borderWidth: 3, pointRadius: 6, pointBackgroundColor: '#fff',
                                pointBorderWidth: 2, tension: 0.4, fill: true, backgroundColor: 'rgba(236, 72, 153, 0.08)'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { backgroundColor: '#1f2937', titleFont: { size: 13, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 10,
                                    callbacks: { label: (c) => 'ì´ì : ' + c.parsed.y.toLocaleString() }
                                }
                            },
                            scales: {
                                y: { beginAtZero: false, grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11, weight: 'bold' }, callback: (v) => v.toLocaleString() } },
                                x: { grid: { display: false }, ticks: { font: { size: 11, weight: 'bold' } } }
                            }
                        }
                    });
                }, 50);
            };
        };
        
        window.setAnalysisSort = (f) => { 
            if(appState.analysisFilters.sortField === f) {
                appState.analysisFilters.sortOrder = appState.analysisFilters.sortOrder === 'asc' ? 'desc' : 'asc'; 
            } else { 
                appState.analysisFilters.sortField = f; 
                appState.analysisFilters.sortOrder = (f==='score'||f==='rank'||f==='avg'||f.startsWith('date_')) ? 'desc' : 'asc'; 
            } 
            window.renderAnalysis(document.getElementById('contentArea'), appState.analysisGuild); 
        };

        window._jobExpanded = false;
        window.updateJobChart = (target) => {
            const container = document.getElementById('jobChartContainer'); if(!container) return;
            const targets = target === 'all' ? appState.members : appState.members.filter(m => m.guild === target);
            const counts = {}; targets.forEach(m => { const j = m.class || 'ë¯¸ì„¤ì •'; counts[j] = (counts[j] || 0) + 1; });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            const maxCount = sorted.length > 0 ? sorted[0][1] : 1;
            const barColors = ['#F9A8D4','#FCA5A5','#FDBA74','#FDE68A','#A7F3D0','#93C5FD','#C4B5FD','#F0ABFC','#6EE7B7','#7DD3FC','#FDA4AF','#D8B4FE','#A5B4FC','#99F6E4'];
            const list = window._jobExpanded ? sorted : sorted.slice(0, 7);
            container.innerHTML = list.map((item, i) => {
                const pct = Math.round((item[1] / maxCount) * 100);
                const color = barColors[i % barColors.length];
                return `<div><div class="flex justify-between items-center mb-1"><span class="text-sm font-bold text-gray-700">${item[0]}</span><span class="text-sm font-black text-gray-500">${item[1]}</span></div><div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"><div class="h-full rounded-full transition-all duration-700" style="width:${pct}%;background:${color}"></div></div></div>`;
            }).join('');
            const btn = document.getElementById('jobToggleBtn');
            if(btn) btn.style.display = sorted.length <= 7 ? 'none' : 'flex';
            const icon = document.getElementById('jobToggleIcon');
            const txt = document.getElementById('jobToggleText');
            if(icon) icon.className = window._jobExpanded ? 'fas fa-chevron-up text-[8px]' : 'fas fa-chevron-down text-[8px]';
            if(txt) txt.textContent = window._jobExpanded ? 'ì ‘ê¸°' : 'ë”ë³´ê¸° (' + (sorted.length - 7) + ')';
        };
        window.toggleJobChart = () => {
            window._jobExpanded = !window._jobExpanded;
            const select = document.querySelector('#jobChartContainer')?.closest('.shrink-0')?.querySelector('select');
            window.updateJobChart(select ? select.value : 'all');
        };

        window._memberSearchTimer = null;
        window.handleSearch = (v) => { appState.filters.search = v; appState.pagination.members = 1; if(window._memberSearchTimer) clearTimeout(window._memberSearchTimer); window._memberSearchTimer = setTimeout(() => window.updateMemberTable(), 100); };
        window.filterByGuild = (g) => { appState.filters.guild = g; appState.pagination.members = 1; if(appState.activeTab === 'members') window.renderMembers(document.getElementById('contentArea')); else window.updateMemberTable(); };
        window.handleSort = (field) => { if(appState.filters.sortField === field) appState.filters.sortOrder = appState.filters.sortOrder === 'asc' ? 'desc' : 'asc'; else { appState.filters.sortField = field; appState.filters.sortOrder = 'asc'; } appState.pagination.members = 1; window.updateMemberTable(); };

        window.renderMembers = (container) => {
            container.innerHTML = `
            <div class="flex flex-col gap-3 fade-in h-full">
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col xl:flex-row items-center gap-4 shrink-0">
                    <div class="flex overflow-x-auto no-scrollbar w-full xl:w-auto gap-2 shrink-0">
                        <button onclick="window.filterByGuild('all')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === 'all' ? 'bg-gray-800 text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">ì „ì²´<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === 'all' ? 'bg-white/20 text-white' : 'bg-gray-200/60 text-gray-400'}">${appState.members.length}</span></button>
                        ${appState.guilds.map(g => { const gc = appState.members.filter(m => m.guild === g.name).length; const gColors = {'ëš ì¹´ë¡±':['bg-pink-500','bg-pink-400/20'],'ëš±ì¹´ë¡±':['bg-rose-600','bg-rose-400/20'],'ë°¤ì¹´ë¡±':['bg-indigo-500','bg-indigo-400/20'],'ë³„ì¹´ë¡±':['bg-amber-500','bg-amber-400/20'],'ë‹¬ì¹´ë¡±':['bg-blue-500','bg-blue-400/20'],'ê¿€ì¹´ë¡±':['bg-orange-500','bg-orange-400/20']}; const [activeBg, activeBadge] = gColors[g.name] || ['bg-pink-500','bg-pink-400/20']; return `<button onclick="window.filterByGuild('${g.name}')" class="shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-1.5 ${appState.filters.guild === g.name ? activeBg + ' text-white shadow-md' : 'bg-gray-50 text-gray-500 hover:bg-gray-100'}">${g.name}<span class="inline-flex items-center justify-center min-w-[18px] h-[16px] px-1 rounded-md text-[9px] font-black ${appState.filters.guild === g.name ? 'bg-white/25 text-white' : 'bg-gray-200/60 text-gray-400'}">${gc}</span></button>`; }).join('')}
                    </div>
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <input type="text" oninput="window.handleSearch(this.value)" value="${appState.filters.search}" class="w-full pl-8 lg:pl-10 pr-3 lg:pr-4 py-2 lg:py-2.5 bg-gray-50 border border-gray-100 rounded-xl outline-none text-[11px] lg:text-xs font-bold shadow-inner focus:ring-2 focus:ring-pink-50 transition-all" placeholder="ë‹‰ë„¤ì„/ë³¸ìº/ì§ì—… ê²€ìƒ‰ (ë‹¤ì¤‘ê²€ìƒ‰)">
                    </div>
                </div>
                <div id="memberTableContainer" class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex-1 min-h-0 flex flex-col"></div>
            </div>`;
            window.updateMemberTable();
        };

        window.updateMemberTable = () => {
            const container = document.getElementById('memberTableContainer'); if(!container) return;
            
            const rawSearchTerm = appState.filters.search.trim();
            const searchTokens = rawSearchTerm.length > 0 
                ? rawSearchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0)
                : [];

            const filtered = appState.members.filter(m => { 
                const gMatch = appState.filters.guild === 'all' || m.guild === appState.filters.guild; 
                if (searchTokens.length === 0) return gMatch;
                const sMatch = searchTokens.some(token => {
                    return m.name.toLowerCase().includes(token) || 
                           (m.class||'').toLowerCase().includes(token) || 
                           (m.role||'').toLowerCase().includes(token) ||
                           (m.mainCharName || '').toLowerCase().includes(token) || 
                           (m.isMain && m.name.toLowerCase().includes(token)); 
                });
                return gMatch && sMatch; 
            });

            filtered.sort((a, b) => smartCompare(a, b, appState.filters.sortField, appState.filters.sortOrder));
            
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            if (appState.pagination.members > totalPages && totalPages > 0) appState.pagination.members = totalPages;
            if (appState.pagination.members < 1) appState.pagination.members = 1;
            
            const pageData = filtered.slice((appState.pagination.members - 1) * ITEMS_PER_PAGE, appState.pagination.members * ITEMS_PER_PAGE);
            const sortIcon = (f) => appState.filters.sortField === f ? (appState.filters.sortOrder === 'asc' ? ' <i class="fas fa-sort-up"></i>' : ' <i class="fas fa-sort-down"></i>') : '';
            
            const isMobile = window.innerWidth < 768;

            let html = '';

            if (isMobile) {
                html = `<div class="flex-1 overflow-y-auto p-3 space-y-2">`;
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-');
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    let roleHtml = formatRoleHtml(m.role);

                    html += `
                    <div class="member-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-gray-400 font-bold w-6 text-center">${globalIndex}</span>
                                ${window.getNicknameIcon(m.role)}
                                <span class="font-bold text-sm text-gray-800">${m.name}</span>
                            </div>
                            ${roleHtml}
                        </div>
                        <div class="flex items-center gap-3 text-[11px] text-gray-500">
                            <span class="bg-gray-50 px-2 py-0.5 rounded-lg">${m.guild}</span>
                            <span class="text-gray-300">|</span>
                            <span>${m.class || '-'}</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-400">ë³¸ìº: ${mainName}</span>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html = `<div class="overflow-y-auto flex-1 relative"><table class="w-full text-left min-w-[800px] text-xs whitespace-nowrap"><thead class="bg-gray-50 text-[10px] font-bold text-gray-500 border-b border-gray-100 shadow-sm"><tr><th class="py-2 px-2 text-center w-12">No.</th><th class="py-2 px-2 sortable" onclick="window.handleSort('name')">ë‹‰ë„¤ì„${sortIcon('name')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('mainInfo')">ë³¸ìº ì •ë³´${sortIcon('mainInfo')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('guild')">ì†Œì†${sortIcon('guild')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('role')">ì§ìœ„${sortIcon('role')}</th><th class="py-2 px-2 sortable" onclick="window.handleSort('class')">ì§ì—…${sortIcon('class')}</th></tr></thead><tbody class="divide-y divide-gray-50 text-gray-600 font-bold">`;
                
                pageData.forEach((m, idx) => {
                    const globalIndex = (appState.pagination.members - 1) * ITEMS_PER_PAGE + idx + 1;
                    const mainName = m.isMain ? m.name : (m.mainCharName || '-'); 
                    const mainMem = appState.members.find(x => x.name === mainName);
                    const mainRankHtml = mainMem ? formatRankWithSuffix(mainMem.role) : '-';
                    
                    const targetRole = mainMem ? mainMem.role : (m.isMain ? m.role : '');
                    let rowStyle = "";
                    const hlCfg = ROW_HIGHLIGHT_ROLES[targetRole];
                    if (hlCfg) {
                        rowStyle = `background:${hlCfg.background};${hlCfg.borderLeft ? 'border-left:' + hlCfg.borderLeft + ';' : ''}`;
                    }

                    let roleHtml = formatRoleHtml(m.role);

                    html += `<tr class="hover:bg-pink-50/30 group transition-colors" style="${rowStyle}">
                        <td class="py-1.5 px-2 text-center text-gray-400 text-[11px]">${globalIndex}</td>
                        <td class="py-1.5 px-2 font-bold text-gray-800 flex items-center leading-none">${window.getNicknameIcon(m.role)}<span class="text-sm tracking-tight">${m.name}</span></td>
                        <td class="py-1.5 px-2 leading-tight">
                            <span class="block text-[11px] font-bold text-gray-700">${mainName}</span>
                            <span class="text-[9px] font-medium text-gray-400">${mainRankHtml}</span>
                        </td>
                        <td class="py-1.5 px-2">${m.guild}</td>
                        <td class="py-1.5 px-2">${roleHtml}</td>
                        <td class="py-1.5 px-2"><span class="text-[10px] text-gray-400">${m.class||'-'}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            html += `<div class="p-3 border-t border-gray-100 flex justify-center items-center gap-4 bg-gray-50/50 relative z-20">
                <button onclick="changePage('members', -1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-600 hover:border-pink-100 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members <= 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-[10px]"></i></button>
                <span class="text-xs font-bold text-gray-500">${appState.pagination.members} / ${totalPages || 1}</span>
                <button onclick="changePage('members', 1)" class="w-8 h-8 flex items-center justify-center rounded-xl bg-white border border-gray-200 text-gray-500 hover:bg-pink-50 hover:text-pink-600 hover:border-pink-100 disabled:opacity-30 disabled:hover:bg-white" ${appState.pagination.members >= totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-[10px]"></i></button>
            </div>`;

            container.innerHTML = html;
        };

        window.renderBail = (container) => {
            const adminStats = window.getAdminBailStats();
            const historyRows = [...appState.bailHistory].reverse().map(h => `<tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs"><td class="p-4 text-gray-400">******</td><td class="p-4 text-blue-500">${h.receiver}</td><td class="p-4 text-right text-pink-500">${h.amount}ê°œ</td></tr>`).join('');
            const statsHtml = adminStats.map(([name, count]) => `<div class="bg-gray-50 rounded-2xl p-4 flex justify-between items-center border border-gray-100 hover:bg-white transition-all shadow-sm"><span class="font-bold text-gray-700 text-xs">${name}</span><span class="font-black text-pink-600 text-lg">${count}ê°œ</span></div>`).join('');
            
            container.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in h-full">
                <div class="lg:col-span-1 bg-white p-10 rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 tracking-tight">ê°„ë¶€ë³„ ë³´ì„ê¸ˆ ìˆ˜ë ¹ ì´ê³„</h3>
                        <p class="text-xs text-gray-400 mt-1 uppercase font-bold tracking-widest">GEM BAIL SUMMARY</p>
                    </div>
                    <div class="grid grid-cols-1 gap-2 flex-1 overflow-y-auto no-scrollbar">
                        ${statsHtml || '<p class="text-[10px] text-gray-300 italic text-center py-4">ë°ì´í„° ì—†ìŒ</p>'}
                    </div>
                </div>
                <div class="lg:col-span-2 bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col h-full overflow-hidden">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë³´ì„ê¸ˆ ë‚´ì—­</h3>
                        <span class="text-[10px] text-gray-400 font-bold italic">Total: ${appState.bailHistory.length}</span>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-5">ë‚©ë¶€ì</th>
                                    <th class="p-5">ìˆ˜ë ¹ì</th>
                                    <th class="p-5 text-right">ìˆ˜ëŸ‰</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${historyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë‚´ì—­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window.renderPenalty = (container) => {
            const activePenaltyCount = appState._activePenaltyCount || 0;

            const penaltyRows = appState.penaltyHistory.map(h => `
                <tr class="hover:bg-gray-50 border-b border-gray-50 h-12 transition-colors font-bold text-xs">
                    <td class="p-4 text-gray-400">******</td>
                    <td class="p-4 text-red-500">${h.points}ì </td>
                    <td class="p-4 text-gray-400 text-[11px]">ë¹„ê³µê°œ</td>
                </tr>
            `).join('');

            container.innerHTML = `
            <div class="flex flex-col gap-6 fade-in h-full">
                <div class="bg-white p-8 rounded-[3rem] border border-gray-100 shadow-sm shrink-0 min-h-[120px]">
                    <div class="mb-4">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">í˜„ì¬ ë²Œì  ê´€ë¦¬ ëŒ€ìƒ</h3>
                        <p class="text-[10px] text-gray-400 mt-1">í˜„ì¬ ë²Œì ì´ ë¶€ì—¬ëœ ì¸ì› ìˆ˜: <span class="text-red-500 font-bold">${activePenaltyCount}ëª…</span></p>
                    </div>
                    <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                        ${activePenaltyCount > 0 
                            ? `<p class="text-xs text-gray-400 font-bold italic">ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ìƒì„¸ ë‚´ì—­ì€ ë¹„ê³µê°œì…ë‹ˆë‹¤.</p>`
                            : '<p class="text-xs text-gray-300 font-bold italic w-full">í˜„ì¬ ë²Œì ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>'
                        }
                    </div>
                </div>

                <div class="bg-white rounded-[3rem] border border-gray-100 shadow-sm flex flex-col flex-1 overflow-hidden h-full">
                    <div class="p-8 border-b border-gray-50 flex justify-between items-center shrink-0">
                        <h3 class="text-sm font-bold text-gray-800 uppercase tracking-widest">ë²Œì  ì´ë ¥</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <table class="w-full text-left text-xs whitespace-nowrap stick-head">
                            <thead class="bg-gray-50 text-[10px] font-bold text-gray-500 uppercase">
                                <tr>
                                    <th class="p-5">ëŒ€ìƒì</th>
                                    <th class="p-5">ì ìˆ˜</th>
                                    <th class="p-5">ì‚¬ìœ </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-50">
                                ${penaltyRows || '<tr><td colspan="3" class="p-20 text-center text-gray-300 font-bold italic">ë²Œì  ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        };

        window.renderGuide = async (container, section) => {
            const guideTab = section || 'intro';
            
            container.innerHTML = `
            <div class="flex flex-col gap-4 fade-in h-full">
                <div class="flex-1 overflow-y-auto no-scrollbar">
                    <div class="p-4 text-center text-gray-300 font-bold text-xs">ë¡œë”© ì¤‘...</div>
                </div>
            </div>`;

            try {
                const { data, error } = await supaDb.from('guide_pages').select('content').eq('slug', guideTab).maybeSingle();
                if (error) throw error;
                
                let body = data?.content || '<p class="text-gray-400 text-center">ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                // Replace dynamic placeholders with actual counts
                body = body.replace(/\{\{ëš ì¹´ë¡±_count\}\}/g, appState.members.filter(m=>m.guild==='ëš ì¹´ë¡±').length);
                body = body.replace(/\{\{ëš±ì¹´ë¡±_count\}\}/g, appState.members.filter(m=>m.guild==='ëš±ì¹´ë¡±').length);
                body = body.replace(/\{\{ë¶€ìº_count\}\}/g, appState.members.filter(m=>['ë°¤ì¹´ë¡±','ë³„ì¹´ë¡±','ë‹¬ì¹´ë¡±','ê¿€ì¹´ë¡±'].includes(m.guild)).length);
                body = body.replace(/\{\{ì „ì²´_count\}\}/g, appState.members.length);
                
                container.innerHTML = `
                <div class="flex flex-col gap-4 fade-in h-full">
                    <div class="flex-1 overflow-y-auto no-scrollbar">${body}</div>
                </div>`;
            } catch(e) {
                console.error(e);
                container.innerHTML = `
                <div class="flex flex-col gap-4 fade-in h-full">
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <p class="text-red-400 text-center font-bold text-xs p-10">ê°€ì´ë“œ ë¡œë”© ì‹¤íŒ¨</p>
                    </div>
                </div>`;
            }
        };

        function initSidebar() {
            const sb = document.getElementById('sidebar'), ov = document.getElementById('sidebarOverlay');
            document.getElementById('openSidebar').onclick = () => { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); };
            document.getElementById('closeSidebar').onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
            ov.onclick = () => { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); };
        }

        document.addEventListener('DOMContentLoaded', () => { initSidebar(); window.fetchMembers(); });
    </script>
</body>
</html>
